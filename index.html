
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æˆ‘çš„ä»“ä½ Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f5f7;
      --bg-card: #ffffff;
      --text-main: #111827;
      --text-sub: #6b7280;
      --border-soft: #e5e7eb;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --accent-strong: #1d4ed8;
      --shadow-soft: 0 20px 40px rgba(15, 23, 42, 0.08);
      --radius-xl: 18px;
      --radius-lg: 14px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
      background: radial-gradient(circle at top left, #e0f2fe 0, #f5f5f7 42%, #f9fafb 100%);
      color: var(--text-main);
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
      gap: 12px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: .02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tag {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(37,99,235,0.08);
      color: var(--accent-strong);
    }

    .title-block p {
      margin: 4px 0 0;
      font-size: 13px;
      color: var(--text-sub);
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 6px 12px;
      font-size: 12px;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(12px);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all .15s ease;
    }

    .btn-primary {
      border-color: transparent;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #fff;
      box-shadow: 0 12px 30px rgba(37,99,235,0.35);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 22px rgba(15,23,42,0.22);
    }

    .btn-primary:hover {
      filter: brightness(1.03);
    }

    .fx-box {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(255,255,255,0.9);
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid var(--border-soft);
      font-size: 12px;
      color: var(--text-sub);
    }

    .fx-box input {
      width: 54px;
      border: none;
      background: transparent;
      font-size: 12px;
      padding: 2px 4px;
      border-radius: 8px;
      text-align: right;
      outline: none;
    }

    .fx-box input:focus {
      background: rgba(209, 213, 219, 0.32);
    }

    /* layout */

    .grid-top {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1fr);
      gap: 16px;
      margin-bottom: 18px;
    }

    .card {
      background: rgba(255,255,255,0.96);
      border-radius: var(--radius-xl);
      padding: 14px 16px 16px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(255,255,255,0.7);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 8px;
    }

    .card-header h2 {
      margin: 0;
      font-size: 15px;
      font-weight: 600;
    }

    .card-header span {
      font-size: 11px;
      color: var(--text-sub);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
    }

    .summary-item {
      border-radius: var(--radius-lg);
      padding: 10px 10px 11px;
      background: linear-gradient(135deg, #f9fafb, #eef2ff);
      border: 1px solid rgba(209,213,219,0.6);
    }

    .summary-label {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 2px;
    }

    .summary-value {
      font-size: 17px;
      font-weight: 600;
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .summary-subvalue {
      font-size: 11px;
      color: var(--text-sub);
    }

    .pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(209,213,219,0.5);
      color: var(--text-sub);
    }

    .pill-strong {
      background: rgba(22,163,74,0.1);
      color: #16a34a;
    }

    /* charts */

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
      margin-top: 4px;
    }

    .chart-wrapper {
      background: #f9fafb;
      border-radius: var(--radius-lg);
      padding: 10px;
      border: 1px solid #e5e7eb;
    }

    .chart-title {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .chart-title span strong {
      color: var(--text-main);
    }

    canvas {
      width: 100% !important;
      height: 220px !important;
    }

    /* detail card */

    .detail-main {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .detail-symbol {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .detail-name {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .detail-name span:first-child {
      font-size: 15px;
      font-weight: 600;
    }

    .detail-name span:last-child {
      font-size: 12px;
      color: var(--text-sub);
    }

    .badge-market {
      padding: 4px 9px;
      border-radius: 999px;
      font-size: 11px;
      background: #eff6ff;
      color: #1d4ed8;
    }

    .badge-category {
      padding: 4px 9px;
      border-radius: 999px;
      font-size: 11px;
      background: #ecfdf3;
      color: #16a34a;
    }

    .detail-metrics {
      display: grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap: 8px;
    }

    .detail-metric {
      padding: 8px 9px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .detail-metric label {
      display: block;
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 2px;
    }

    .detail-metric div {
      font-size: 14px;
      font-weight: 500;
    }

    .risk-pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .risk-low {
      background: rgba(22,163,74,0.08);
      color: #15803d;
    }
    .risk-mid {
      background: rgba(234,179,8,0.12);
      color: #92400e;
    }
    .risk-high {
      background: rgba(220,38,38,0.08);
      color: #b91c1c;
    }

    /* table area */

    .grid-bottom {
      display: grid;
      grid-template-columns: minmax(0,2.2fr) minmax(0,1.1fr);
      gap: 16px;
      margin-top: 6px;
    }

    .table-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .search-box {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      flex: 1;
      min-width: 150px;
    }

    .search-box input {
      border: none;
      background: transparent;
      font-size: 12px;
      outline: none;
      width: 100%;
    }

    .sort-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .btn-chip {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 4px 9px;
      font-size: 11px;
      cursor: pointer;
      color: #4b5563;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-chip.active {
      background: var(--accent-soft);
      color: var(--accent-strong);
      border-color: #bfdbfe;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: #f3f4f6;
    }

    th, td {
      padding: 6px 8px;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 500;
      color: #6b7280;
      border-bottom: 1px solid #e5e7eb;
    }

    tbody tr {
      border-bottom: 1px solid #f3f4f6;
      cursor: pointer;
      transition: background .12s ease;
    }

    tbody tr:hover {
      background: #f9fafb;
    }

    tr.selected {
      background: #eff6ff !important;
    }

    .col-name {
      font-weight: 500;
      color: var(--text-main);
    }

    .col-symbol {
      color: #6b7280;
      font-size: 11px;
    }

    .col-market {
      font-size: 11px;
      color: #6b7280;
    }

    .col-category {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f3f4ff;
      color: #4f46e5;
      display: inline-block;
    }

    .col-value {
      font-feature-settings: "tnum" 1, "lnum" 1;
    }

    .col-weight {
      font-size: 11px;
      color: #4b5563;
    }

    .weight-bar-wrapper {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .weight-bar {
      flex: 1;
      height: 4px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
    }

    .weight-bar-inner {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg,#2563eb,#4f46e5);
      transform-origin: left;
      transform: scaleX(0.4);
    }

    .weight-text {
      font-size: 11px;
      color: #4b5563;
      min-width: 42px;
      text-align: right;
    }

    @media (max-width: 900px) {
      .grid-top,
      .grid-bottom {
        grid-template-columns: minmax(0,1fr);
      }
    }

    @media (max-width: 600px) {
      .summary-grid {
        grid-template-columns: minmax(0,1fr);
      }
      canvas {
        height: 200px !important;
      }
      .card {
        padding: 12px 12px 13px;
      }
      .toolbar {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="header">
      <div class="title-block">
        <h1>
          æˆ‘çš„ä»“ä½ä»ªè¡¨ç›˜
          <span class="tag">å®æ—¶ Â· å¯äº¤äº’</span>
        </h1>
        <p id="subtitle">è½½å…¥ä¸­...</p>
      </div>
      <div class="toolbar">
        <div class="fx-box">
          <span>1 USD =</span>
          <input id="fxInput" type="number" step="0.01" value="7.80" />
          <span>HKD</span>
        </div>
        <button class="btn btn-primary" id="refreshBtn">
          ğŸ”„ é‡æ–°è½½å…¥
        </button>
      </div>
    </header>

    <!-- é¡¶éƒ¨ï¼šæ€»è§ˆ + å›¾è¡¨ -->
    <section class="grid-top">
      <div class="card">
        <div class="card-header">
          <div>
            <h2>è´¦æˆ·æ€»è§ˆ</h2>
            <span>åŸºäº data.json å½“å‰æ•°æ®</span>
          </div>
          <span class="pill" id="positionCount">0 ä¸ªæŒä»“</span>
        </div>
        <div class="summary-grid">
          <div class="summary-item">
            <div class="summary-label">ç»„åˆå¸‚å€¼ï¼ˆUSDï¼‰</div>
            <div class="summary-value">
              <span id="totalValue">$0</span>
            </div>
            <div class="summary-subvalue">æ¸¯è‚¡å·²æŒ‰å½“å‰æ±‡ç‡æŠ˜ç®—</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">å¸‚åœºåˆ†å¸ƒ</div>
            <div class="summary-value">
              <span id="usValue">$0</span>
              <span class="summary-subvalue">ç¾è‚¡</span>
            </div>
            <div class="summary-subvalue">
              æ¸¯è‚¡ <span id="hkValue">$0</span>
            </div>
          </div>
          <div class="summary-item">
            <div class="summary-label">ä»“ä½é›†ä¸­åº¦</div>
            <div class="summary-value">
              <span id="top3Weight">0%</span>
              <span class="summary-subvalue">å‰ 3 å¤§æŒä»“å æ¯”</span>
            </div>
            <div class="summary-subvalue" id="riskHint">ä»“ä½è¾ƒåˆ†æ•£ï¼Œé£é™©ç›¸å¯¹æ¸©å’Œ</div>
          </div>
        </div>

        <div class="charts-grid">
          <div class="chart-wrapper">
            <div class="chart-title">
              <span><strong>æ ‡çš„ç»´åº¦</strong> Â· æŒä»“å¸‚å€¼å æ¯”</span>
              <span style="font-size:11px;color:#9ca3af;">ç‚¹å‡»å›¾å—å¯æŸ¥çœ‹å³ä¾§è¯¦æƒ…</span>
            </div>
            <canvas id="bySymbol"></canvas>
          </div>
          <div class="chart-wrapper">
            <div class="chart-title">
              <span><strong>èµ„äº§ç±»å‹</strong> Â· ç»“æ„è§†å›¾</span>
              <span id="categoryHint" style="font-size:11px;color:#9ca3af;"></span>
            </div>
            <canvas id="byCategory"></canvas>
          </div>
        </div>
      </div>

      <!-- å³ä¾§è¯¦æƒ…å¡ç‰‡ -->
      <div class="card">
        <div class="card-header">
          <div>
            <h2>æŒä»“è¯¦æƒ…</h2>
            <span id="detailSubtitle">ç‚¹å‡»å·¦ä¾§å›¾è¡¨æˆ–ä¸‹æ–¹è¡¨æ ¼æŸ¥çœ‹å•ç¥¨è¯¦æƒ…</span>
          </div>
        </div>
        <div class="detail-main" id="detailPanel">
          <div style="font-size:13px;color:#6b7280;line-height:1.5;">
            ğŸ‘ˆ ä»å·¦ä¾§åœ†ç¯å›¾ä¸­ç‚¹ä¸€ä¸‹ä»»æ„æ ‡çš„ï¼Œæˆ–åœ¨ä¸‹æ–¹è¡¨æ ¼ä¸­ç‚¹é€‰ä¸€è¡Œï¼Œè¿™é‡Œä¼šå±•ç¤ºè¯¥æ ‡çš„çš„ï¼š
            <br />Â· å¸‚å€¼ã€ä»“ä½å æ¯”
            <br />Â· æ‰€å±å¸‚åœºä¸ç±»åˆ«
            <br />Â· ç®€å•é£é™©æ ‡ç­¾ï¼ˆæ ¹æ®ä»“ä½å¤§å°ï¼‰
          </div>
        </div>
      </div>
    </section>

    <!-- åº•éƒ¨ï¼šè¡¨æ ¼ + è¯´æ˜ -->
    <section class="grid-bottom">
      <div class="card">
        <div class="card-header">
          <div>
            <h2>æŒä»“åˆ—è¡¨</h2>
            <span>å¯æœç´¢ / æ’åº / ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</span>
          </div>
        </div>

        <div class="table-toolbar">
          <div class="search-box">
            ğŸ”
            <input id="searchInput" placeholder="æŒ‰ä»£ç  / åç§°æœç´¢..." />
          </div>
          <div class="sort-buttons">
            <button class="btn-chip active" data-sort="value">
              å¸‚å€¼
            </button>
            <button class="btn-chip" data-sort="weight">
              ä»“ä½å æ¯”
            </button>
            <button class="btn-chip" data-sort="symbol">
              ä»£ç 
            </button>
          </div>
        </div>

        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>åç§° / ä»£ç </th>
                <th>å¸‚åœº</th>
                <th>ç±»åˆ«</th>
                <th>å¸‚å€¼ (USD)</th>
                <th>ä»“ä½</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <!-- rows -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <h2>ä½¿ç”¨è¯´æ˜</h2>
            <span>æœ¬é¡µå®Œå…¨åŸºäº data.jsonï¼Œåç»­ä½ åªæ”¹ä¸€ä»½æ•°æ®å³å¯</span>
          </div>
        </div>
        <ul style="padding-left:16px;margin:0;font-size:13px;color:#4b5563;line-height:1.6;">
          <li>ä¸Šæ–¹æ±‡ç‡æ¡†ï¼šè°ƒæ•´ HKDâ†’USD æŠ˜ç®—ï¼Œæ‰€æœ‰å›¾è¡¨å’Œåˆ—è¡¨ä¼šåŒæ­¥åˆ·æ–°ã€‚</li>
          <li>åœ†ç¯å›¾ï¼šé¼ æ ‡ç‚¹å‡»æŸä¸ªæ‰‡åŒºï¼Œä¼šåœ¨å³ä¾§è¯¦æƒ…å¡å±•ç¤ºè¯¥æ ‡çš„ã€‚</li>
          <li>è¡¨æ ¼ï¼šæ”¯æŒæœç´¢ã€æŒ‰å¸‚å€¼/ä»“ä½/ä»£ç æ’åºï¼Œç‚¹å‡»ä¸€è¡Œä¹Ÿä¼šè”åŠ¨è¯¦æƒ…å¡ã€‚</li>
          <li>å¦‚æœä½ ä»¥åæƒ³åŠ å…¥æˆæœ¬ã€ç›ˆäºç­‰å­—æ®µï¼Œåªéœ€åœ¨ data.json é‡Œä¸ºæ¯ä¸ªæ ‡çš„å¤šåŠ å­—æ®µï¼Œå‰ç«¯å¯ä»¥å†å‡çº§å±•ç¤ºæ›´å¤šä¿¡æ¯ã€‚</li>
        </ul>
      </div>
    </section>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    let FX = 7.8;
    let rawPositions = [];
    let derived = [];
    let totalUsd = 0;
    let symbolChart, categoryChart;
    let currentSort = { key: 'value', asc: false };
    let currentFilter = '';

    const catMap = {
      core: 'æ ¸å¿ƒæŒ‡æ•°',
      tech: 'ç§‘æŠ€å·¨å¤´',
      satellite: 'å«æ˜Ÿèµ„äº§'
    };

    const catOrder = ['core','tech','satellite'];

    document.getElementById('fxInput').addEventListener('change', e => {
      const v = parseFloat(e.target.value);
      if (!isNaN(v) && v > 0) {
        FX = v;
        recomputeAndRender();
      }
    });

    document.getElementById('refreshBtn').addEventListener('click', () => {
      loadData(true);
    });

    document.getElementById('searchInput').addEventListener('input', e => {
      currentFilter = e.target.value.trim().toLowerCase();
      renderTable();
    });

    document.querySelectorAll('.btn-chip').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.btn-chip').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const key = btn.getAttribute('data-sort');
        if (currentSort.key === key) {
          currentSort.asc = !currentSort.asc;
        } else {
          currentSort.key = key;
          currentSort.asc = key === 'symbol'; // é»˜è®¤ä»£ç å‡åºï¼Œæ•°å€¼é™åº
        }
        renderTable();
      });
    });

    async function loadData(bustCache = false) {
      try {
        const url = 'data.json' + (bustCache ? ('?ts=' + Date.now()) : '');
        const res = await fetch(url);
        rawPositions = await res.json();
        document.getElementById('positionCount').textContent = rawPositions.length + ' ä¸ªæŒä»“';
        recomputeAndRender();
      } catch (err) {
        console.error(err);
        document.getElementById('subtitle').textContent = 'åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ data.json æ˜¯å¦å­˜åœ¨';
      }
    }

    function toUsd(p) {
      return p.market === 'HK' ? p.value / FX : p.value;
    }

    function recomputeAndRender() {
      if (!rawPositions || !rawPositions.length) return;
      derived = rawPositions.map((p, idx) => ({
        ...p,
        index: idx,
        usd: toUsd(p)
      }));
      totalUsd = derived.reduce((s,p)=>s+p.usd,0);

      // æ’åºç”¨äº top3 ä¹‹ç±»
      const sortedByValue = [...derived].sort((a,b)=>b.usd-a.usd);
      const top3Usd = sortedByValue.slice(0,3).reduce((s,p)=>s+p.usd,0);
      const top3Weight = totalUsd ? top3Usd / totalUsd * 100 : 0;
      document.getElementById('top3Weight').textContent = top3Weight.toFixed(1) + '%';
      let riskHint = 'ä»“ä½è¾ƒåˆ†æ•£ï¼Œé£é™©ç›¸å¯¹æ¸©å’Œ';
      if (top3Weight > 65) riskHint = 'å‰å‡ å¤§æŒä»“å¾ˆé›†ä¸­ï¼Œè¯·æ³¨æ„å•ç¥¨æ³¢åŠ¨é£é™©';
      else if (top3Weight > 45) riskHint = 'æœ‰ä¸€å®šé›†ä¸­åº¦ï¼Œå¯ç•™æ„é¾™å¤´ä»“ä½é£é™©';
      document.getElementById('riskHint').textContent = riskHint;

      const usValue = derived.filter(p=>p.market==='US').reduce((s,p)=>s+p.usd,0);
      const hkValue = derived.filter(p=>p.market==='HK').reduce((s,p)=>s+p.usd,0);

      document.getElementById('subtitle').textContent =
        'å½“å‰ç»„åˆå¸‚å€¼ï¼ˆæŠ˜ç®— USDï¼‰ Â· å…± ' + rawPositions.length + ' ä¸ªæŒä»“';
      document.getElementById('totalValue').textContent = '$' + totalUsd.toFixed(2);
      document.getElementById('usValue').textContent = '$' + usValue.toFixed(2);
      document.getElementById('hkValue').textContent = '$' + hkValue.toFixed(2);

      renderCharts();
      renderTable();
      updateCategoryHint();
    }

    function renderCharts() {
      const symbolLabels = derived.map(p => p.symbol + ' ' + p.name);
      const symbolData = derived.map(p => p.usd);

      const catAgg = { core:0, tech:0, satellite:0 };
      derived.forEach(p => {
        if (p.category && catAgg[p.category] != null) {
          catAgg[p.category] += p.usd;
        }
      });

      const categoryLabels = catOrder
        .filter(c=>catAgg[c]>0)
        .map(c => catMap[c]);
      const categoryData = catOrder
        .filter(c=>catAgg[c]>0)
        .map(c => catAgg[c]);

      const symbolCtx = document.getElementById('bySymbol').getContext('2d');
      const catCtx = document.getElementById('byCategory').getContext('2d');

      if (symbolChart) symbolChart.destroy();
      if (categoryChart) categoryChart.destroy();

      symbolChart = new Chart(symbolCtx, {
        type: 'doughnut',
        data: {
          labels: symbolLabels,
          datasets: [{
            data: symbolData,
            hoverOffset: 6,
          }]
        },
        options: {
          responsive: true,
          animation: {
            animateRotate: true,
            animateScale: true
          },
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const v = ctx.raw;
                  const pct = totalUsd ? (v / totalUsd * 100).toFixed(2) : 0;
                  return `${ctx.label}: $${v.toFixed(2)} (${pct}%)`;
                }
              }
            }
          },
          onClick: (evt, elements) => {
            if (!elements.length) return;
            const idx = elements[0].index;
            const p = derived[idx];
            if (p) {
              selectPosition(p.index);
            }
          }
        }
      });

      categoryChart = new Chart(catCtx, {
        type: 'doughnut',
        data: {
          labels: categoryLabels,
          datasets: [{
            data: categoryData
          }]
        },
        options: {
          responsive: true,
          animation: {
            animateRotate: true,
            animateScale: true
          },
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const sum = categoryData.reduce((a,b)=>a+b,0);
                  const v = ctx.raw;
                  const pct = sum ? (v / sum * 100).toFixed(2) : 0;
                  return `${ctx.label}: $${v.toFixed(2)} (${pct}%)`;
                }
              }
            }
          }
        }
      });
    }

    function updateCategoryHint() {
      const catAgg = { core:0, tech:0, satellite:0 };
      derived.forEach(p => {
        if (p.category && catAgg[p.category] != null) {
          catAgg[p.category] += p.usd;
        }
      });
      const total = Object.values(catAgg).reduce((a,b)=>a+b,0);
      if (!total) {
        document.getElementById('categoryHint').textContent = '';
        return;
      }
      const pieces = [];
      catOrder.forEach(c => {
        if (catAgg[c] > 0) {
          const pct = (catAgg[c] / total * 100).toFixed(1);
          pieces.push(`${catMap[c]} ${pct}%`);
        }
      });
      document.getElementById('categoryHint').textContent = pieces.join(' Â· ');
    }

    function renderTable() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      let list = [...derived];

      if (currentFilter) {
        list = list.filter(p =>
          (p.symbol && p.symbol.toLowerCase().includes(currentFilter)) ||
          (p.name && p.name.toLowerCase().includes(currentFilter))
        );
      }

      list.sort((a,b) => {
        const key = currentSort.key;
        let va, vb;
        if (key === 'value') {
          va = a.usd; vb = b.usd;
        } else if (key === 'weight') {
          va = totalUsd ? a.usd/totalUsd : 0;
          vb = totalUsd ? b.usd/totalUsd : 0;
        } else if (key === 'symbol') {
          va = a.symbol || '';
          vb = b.symbol || '';
        } else {
          va = 0; vb = 0;
        }
        if (typeof va === 'string') {
          return currentSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
        }
        return currentSort.asc ? va - vb : vb - va;
      });

      list.forEach(p => {
        const tr = document.createElement('tr');
        tr.dataset.index = p.index;

        const weight = totalUsd ? p.usd / totalUsd * 100 : 0;
        const weightClass =
          weight > 12 ? 'risk-high' :
          weight > 6 ? 'risk-mid' : 'risk-low';

        tr.innerHTML = `
          <td>
            <div class="col-name">${p.name}</div>
            <div class="col-symbol">${p.symbol}</div>
          </td>
          <td><span class="col-market">${p.market === 'US' ? 'ç¾è‚¡' : 'æ¸¯è‚¡'}</span></td>
          <td><span class="col-category">${catMap[p.category] || 'å…¶ä»–'}</span></td>
          <td class="col-value">$${p.usd.toFixed(2)}</td>
          <td>
            <div class="weight-bar-wrapper">
              <div class="weight-bar">
                <div class="weight-bar-inner" style="transform:scaleX(${Math.min(weight/20,1).toFixed(2)});"></div>
              </div>
              <div class="weight-text">${weight.toFixed(1)}%</div>
            </div>
          </td>
        `;

        tr.addEventListener('click', () => {
          selectPosition(p.index);
        });

        tbody.appendChild(tr);
      });

      // æ¸…é™¤åŸæœ‰é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('#tableBody tr').forEach(tr => tr.classList.remove('selected'));
    }

    function selectPosition(idx) {
      const p = derived.find(x => x.index === idx);
      if (!p) return;

      // é«˜äº®è¡¨æ ¼è¡Œ
      document.querySelectorAll('#tableBody tr').forEach(tr => {
        if (parseInt(tr.dataset.index,10) === idx) tr.classList.add('selected');
        else tr.classList.remove('selected');
      });

      const weight = totalUsd ? p.usd / totalUsd * 100 : 0;
      let riskClass = 'risk-low';
      let riskText = 'ä»“ä½è¾ƒå°ï¼Œé£é™©å¯æ§';
      if (weight > 12) {
        riskClass = 'risk-high';
        riskText = 'å•ç¥¨ä»“ä½åå¤§ï¼Œéœ€å…³æ³¨æ³¢åŠ¨é£é™©';
      } else if (weight > 6) {
        riskClass = 'risk-mid';
        riskText = 'ä¸­ç­‰ä»“ä½ï¼Œæ³¨æ„æ§åˆ¶å›æ’¤';
      }

      const detail = document.getElementById('detailPanel');
      detail.innerHTML = `
        <div class="detail-symbol">
          <div class="detail-name">
            <span>${p.name}</span>
            <span>${p.symbol} Â· ${p.market === 'US' ? 'ç¾è‚¡' : 'æ¸¯è‚¡'}</span>
          </div>
          <div style="display:flex;gap:6px;">
            <span class="badge-market">${p.market === 'US' ? 'US' : 'HK'}</span>
            <span class="badge-category">${catMap[p.category] || 'å…¶ä»–'}</span>
          </div>
        </div>

        <div class="detail-metrics">
          <div class="detail-metric">
            <label>å¸‚å€¼ (USD)</label>
            <div>$${p.usd.toFixed(2)}</div>
          </div>
          <div class="detail-metric">
            <label>ä»“ä½å æ¯”</label>
            <div>${weight.toFixed(2)}%</div>
          </div>
          <div class="detail-metric">
            <label>åŸå§‹å¸ç§å¸‚å€¼</label>
            <div>${p.market === 'US' ? '$' + p.value.toFixed(2) : p.value.toFixed(2) + ' HKD'}</div>
          </div>
          <div class="detail-metric">
            <label>é£é™©æ ‡ç­¾</label>
            <div>
              <span class="risk-pill ${riskClass}">
                â— ${riskText}
              </span>
            </div>
          </div>
        </div>
      `;

      document.getElementById('detailSubtitle').textContent = 'å·²é€‰ä¸­ï¼š' + p.name + 'ï¼ˆ' + p.symbol + 'ï¼‰';
    }

    // åˆå§‹åŒ–
    loadData(false);
  </script>
</body>
</html>
