
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>我的投资组合 Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 字体 & 图标 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <style>
    :root {
      --bg-main: #020617;
      --bg-card: #0b1220;
      --bg-card-soft: #020617;
      --border-subtle: #1f2937;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.12);
      --accent2: #38bdf8;
      --accent2-soft: rgba(56, 189, 248, 0.16);
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --text-muted: #6b7280;
      --danger: #f97373;
      --danger-soft: rgba(248, 113, 113, 0.16);
      --warn: #facc15;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.75);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro SC", "PingFang SC", "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 50%, #000 100%);
      color: var(--text-main);
      min-height: 100%;
    }

    body {
      padding: 18px 16px 48px;
    }

    .app-shell {
      max-width: 1280px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .title-main {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .title-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: linear-gradient(to right, rgba(56, 189, 248, 0.16), rgba(34, 197, 94, 0.14));
      color: var(--accent2);
      border: 1px solid rgba(56, 189, 248, 0.25);
    }

    .title-sub {
      font-size: 13px;
      color: var(--text-muted);
    }

    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.85);
      color: var(--text-main);
      padding: 7px 14px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.16s ease;
    }
    .btn span.icon {
      font-size: 14px;
    }

    .btn:hover {
      border-color: rgba(56, 189, 248, 0.7);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), #020617);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.3);
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #4ade80);
      color: #0f172a;
      border-color: transparent;
      box-shadow: 0 10px 25px rgba(34, 197, 94, 0.42);
    }
    .btn-primary:hover {
      filter: brightness(1.06);
      box-shadow: 0 14px 35px rgba(34, 197, 94, 0.58);
    }

    /* Top stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    @media (max-width: 960px) {
      .stats-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    @media (max-width: 640px) {
      .stats-grid {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }
    }

    .stat-card {
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.94), #020617);
      padding: 12px 14px;
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.85);
      position: relative;
      overflow: hidden;
    }
    .stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 6px;
    }
    .stat-value {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 3px;
    }
    .stat-sub {
      font-size: 12px;
      color: var(--text-sub);
    }
    .pill {
      border-radius: 999px;
      padding: 2px 10px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .pill-green {
      background: var(--accent-soft);
      color: var(--accent);
    }
    .pill-red {
      background: var(--danger-soft);
      color: var(--danger);
    }
    .pill-yellow {
      background: rgba(250, 204, 21, 0.16);
      color: var(--warn);
    }

    /* Main layout */
    .main-grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 2.4fr);
      gap: 16px;
      margin-bottom: 18px;
    }
    @media (max-width: 960px) {
      .main-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), #020617);
      padding: 12px;
      box-shadow: var(--shadow-soft);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .card-title {
      font-size: 13px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-title span.dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #38bdf8);
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.36);
    }
    .card-subtitle {
      font-size: 11px;
      color: var(--text-sub);
    }

    .chart-wrapper {
      width: 100%;
      height: 280px;
    }
    @media (max-width: 640px) {
      .chart-wrapper {
        height: 240px;
      }
    }

    /* Positions table / cards */
    .positions-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 420px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .position-card {
      border-radius: var(--radius-md);
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: linear-gradient(135deg, rgba(15,23,42,0.97), #020617);
      padding: 8px 10px;
      display: grid;
      grid-template-columns: minmax(0, 1.8fr) repeat(4, minmax(0, 1fr)) auto;
      gap: 6px;
      align-items: center;
      font-size: 12px;
    }
    @media (max-width: 960px) {
      .position-card {
        grid-template-columns: minmax(0, 1.7fr) repeat(3, minmax(0, 1fr)) auto;
      }
      .pos-hide-tablet {
        display: none;
      }
    }
    @media (max-width: 680px) {
      .position-card {
        grid-template-columns: minmax(0, 1.7fr) repeat(2, minmax(0, 1.2fr));
        grid-auto-rows: auto;
      }
      .pos-hide-mobile {
        display: none;
      }
    }

    .pos-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .pos-name-line {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }
    .pos-symbol {
      font-size: 13px;
    }
    .pos-name {
      font-size: 12px;
      color: var(--text-sub);
    }
    .tag {
      border-radius: 999px;
      padding: 1px 8px 2px;
      font-size: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: var(--text-muted);
    }
    .tag-tech {
      border-color: rgba(56,189,248,0.8);
      color: var(--accent2);
      background: rgba(15,23,42,0.7);
    }
    .tag-core {
      border-color: rgba(34,197,94,0.8);
      color: var(--accent);
      background: rgba(15,23,42,0.7);
    }
    .tag-sat {
      border-color: rgba(250,204,21,0.8);
      color: var(--warn);
      background: rgba(15,23,42,0.7);
    }

    .pos-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 2px;
    }
    .pos-value-main {
      font-size: 13px;
      font-weight: 500;
    }
    .pos-value-sub {
      font-size: 11px;
      color: var(--text-sub);
    }

    .pos-pl-pos {
      color: var(--accent);
    }
    .pos-pl-neg {
      color: var(--danger);
    }

    .small-btn {
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 11px;
      border: 1px solid rgba(55,65,81, 0.9);
      background: rgba(15,23,42,0.9);
      color: var(--text-sub);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: all 0.15s ease;
    }
    .small-btn:hover {
      border-color: rgba(56,189,248,0.9);
      color: var(--accent2);
    }

    /* Trade panel & plan */
    .bottom-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.7fr) minmax(0, 2.3fr);
      gap: 16px;
    }
    @media (max-width: 960px) {
      .bottom-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .form-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .form-col {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    label {
      font-size: 11px;
      color: var(--text-sub);
    }
    input, select, textarea {
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: #020617;
      color: var(--text-main);
      padding: 7px 9px;
      font-size: 12px;
      font-family: inherit;
      outline: none;
      transition: all 0.15s ease;
    }
    input:focus, select:focus, textarea:focus {
      border-color: rgba(56, 189, 248, 0.85);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.45);
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .muted-hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .trades-list {
      margin-top: 8px;
      border-radius: 12px;
      border: 1px dashed var(--border-subtle);
      padding: 6px 8px;
      max-height: 130px;
      overflow-y: auto;
      font-size: 11px;
      color: var(--text-sub);
    }
    .trades-list-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      padding: 2px 0;
    }

    .chip {
      border-radius: 999px;
      padding: 1px 7px;
      font-size: 10px;
      border: 1px solid rgba(55,65,81, 0.9);
      color: var(--text-muted);
    }

    .chip-buy {
      border-color: rgba(34,197,94,0.8);
      color: var(--accent);
      background: rgba(15,23,42,0.8);
    }
    .chip-sell {
      border-color: rgba(248,113,113,0.8);
      color: var(--danger);
      background: rgba(15,23,42,0.8);
    }

    .toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.7);
      background: rgba(15,23,42,0.97);
      color: var(--accent2);
      font-size: 12px;
      display: none;
      align-items: center;
      gap: 8px;
      z-index: 50;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- Header -->
    <header class="header">
      <div class="title-block">
        <div class="title-main">
          投资组合总览
          <span class="title-badge">实时行情 + 动态持仓</span>
        </div>
        <div class="title-sub">
          本地保存交易记录 · 深色 TradingView 风格 ·
          <span id="last-update">行情加载中...</span>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn" id="refresh-quotes">
          <span class="icon">⟳</span> 刷新行情
        </button>
        <button class="btn-primary" id="reset-data">
          重置本地数据
        </button>
      </div>
    </header>

    <!-- Top stats -->
    <section class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">组合总市值 (估算)</div>
        <div class="stat-value" id="stat-total-value">--</div>
        <div class="stat-sub">
          <span class="pill pill-yellow">
            ⚠ 未进行汇率换算 · HKD + USD 直接相加
          </span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">浮动盈亏</div>
        <div class="stat-value" id="stat-unrealized-pl">--</div>
        <div class="stat-sub">
          <span class="pill" id="stat-unrealized-rate-pill">--</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">今日盈亏 (按行情变动)</div>
        <div class="stat-value" id="stat-today-pl">--</div>
        <div class="stat-sub">
          <span class="pill" id="stat-today-rate-pill">--</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">仓位对象</div>
        <div class="stat-value">Core 35% · Tech 55% · High-Vol 10%</div>
        <div class="stat-sub">
          <span class="pill pill-green">
            ✓ 当前页面仅展示股票仓位 · 目标结构依据你的偏好
          </span>
        </div>
      </div>
    </section>

    <!-- Charts + positions -->
    <section class="main-grid">
      <!-- Charts -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span class="dot"></span>
              持仓占比 & 成本对比
            </div>
            <div class="card-subtitle">
              左：按市值占比饼图 · 右：各标的成本 vs 当前市值
            </div>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1.1fr 1.1fr; gap: 8px;">
          <div id="pie-chart" class="chart-wrapper"></div>
          <div id="bar-chart" class="chart-wrapper"></div>
        </div>
      </div>

      <!-- Positions -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span class="dot"></span>
              持仓明细
            </div>
            <div class="card-subtitle">
              支持多笔买卖 · 自动计算成本、仓位、盈亏
            </div>
          </div>
        </div>
        <div class="positions-container" id="positions-list">
          <!-- 动态填充 -->
        </div>
      </div>
    </section>

    <!-- Trades + plan -->
    <section class="bottom-grid">
      <!-- Trade form -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span class="dot"></span>
              记录一笔交易
            </div>
            <div class="card-subtitle">
              信息仅存储在本机浏览器，不会上传到服务器
            </div>
          </div>
        </div>

        <form id="trade-form">
          <div class="form-row">
            <div class="form-col">
              <label for="trade-symbol">标的</label>
              <select id="trade-symbol" required></select>
            </div>
            <div class="form-col">
              <label for="trade-type">方向</label>
              <select id="trade-type">
                <option value="buy">买入</option>
                <option value="sell">卖出</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-col">
              <label for="trade-price">价格</label>
              <input type="number" step="0.0001" id="trade-price" placeholder="例如 250.5" required />
            </div>
            <div class="form-col">
              <label for="trade-qty">数量</label>
              <input type="number" step="0.0001" id="trade-qty" placeholder="例如 10" required />
            </div>
          </div>

          <div class="form-row">
            <div class="form-col">
              <label for="trade-date">日期</label>
              <input type="date" id="trade-date" />
            </div>
            <div class="form-col" style="align-items: flex-end; justify-content: flex-end;">
              <button type="submit" class="btn-primary" style="padding: 6px 18px; font-size: 13px;">
                保存交易
              </button>
            </div>
          </div>
          <div class="muted-hint">
            小提示：支持多笔买入/卖出，系统会按照加权平均计算成本。卖出会按比例减少持仓成本并不计入未实现盈亏。
          </div>
        </form>

        <div class="trades-list" id="trades-list">
          <div style="color: var(--text-muted);">暂无交易记录。保存交易后将在此展示最近记录。</div>
        </div>
      </div>

      <!-- Plan / notes -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span class="dot"></span>
              加仓 / 调仓计划
            </div>
            <div class="card-subtitle">
              写下你接下来一周或一月的投资操作计划，这里会自动本地保存
            </div>
          </div>
        </div>

        <div class="form-col">
          <label for="plan-notes">计划 & 规则</label>
          <textarea id="plan-notes" placeholder="例如：
- NVDA 分批加仓，总仓位控制在 20% 以内
- QQQM 定投每月固定金额
- 港股仓位维持在总仓位的 30% 左右
- 当某单一标的浮亏超过 15% 时，暂停加仓，等待信号再操作"></textarea>
        </div>
        <div class="muted-hint">
          计划会自动保存到浏览器本地存储。你可以把这里当成「投资日记 + 加仓策略」。
        </div>
      </div>
    </section>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <span>✓ 已保存</span>
    <span id="toast-text"></span>
  </div>

  <script>
    // ------------------------
    // 全局状态
    // ------------------------
    const TRADES_KEY = "portfolio_trades_v1";
    const PLAN_KEY = "portfolio_plan_notes_v1";
    const YAHOO_ENDPOINT =
      "https://query1.finance.yahoo.com/v7/finance/quote?symbols=";

    let rawPositions = [];
    let positions = []; // 带行情 & 交易信息
    let tradesBySymbol = {};
    let pieChart, barChart;

    // ------------------------
    // 工具函数
    // ------------------------
    function formatNumber(n, digits = 2) {
      if (n === null || n === undefined || isNaN(n)) return "--";
      return Number(n).toLocaleString("zh-CN", {
        minimumFractionDigits: digits,
        maximumFractionDigits: digits,
      });
    }

    function formatPercent(n, digits = 2) {
      if (n === null || n === undefined || isNaN(n)) return "--";
      return (n >= 0 ? "+" : "") + n.toFixed(digits) + "%";
    }

    function showToast(msg) {
      const el = document.getElementById("toast");
      const txt = document.getElementById("toast-text");
      txt.textContent = msg || "";
      el.style.display = "flex";
      setTimeout(() => {
        el.style.display = "none";
      }, 2200);
    }

    function yahooSymbol(p) {
      if (p.market === "HK") return p.symbol + ".HK";
      // 这里可以根据需要扩展其他市场
      return p.symbol;
    }

    // ------------------------
    // 本地存储：交易 & 计划
    // ------------------------
    function loadTradesFromStorage() {
      try {
        const raw = localStorage.getItem(TRADES_KEY);
        tradesBySymbol = raw ? JSON.parse(raw) : {};
      } catch (e) {
        tradesBySymbol = {};
      }
    }

    function saveTradesToStorage() {
      localStorage.setItem(TRADES_KEY, JSON.stringify(tradesBySymbol));
    }

    function loadPlanFromStorage() {
      const txt = localStorage.getItem(PLAN_KEY) || "";
      document.getElementById("plan-notes").value = txt;
    }

    function savePlanToStorage() {
      const txt = document.getElementById("plan-notes").value || "";
      localStorage.setItem(PLAN_KEY, txt);
      showToast("计划已保存");
    }

    // ------------------------
    // 交易 & 持仓计算逻辑（多笔买卖）
    // ------------------------
    function computePositionFromTrades(symbol, currentPrice) {
      const trades = tradesBySymbol[symbol] || [];
      let shares = 0;
      let cost = 0;

      for (const t of trades) {
        const qty = Number(t.qty);
        const price = Number(t.price);
        if (!qty || !price) continue;

        if (t.type === "buy") {
          // 买入：增加持仓和成本
          shares += qty;
          cost += qty * price;
        } else if (t.type === "sell") {
          // 卖出：按当前成本价比例减少
          if (shares <= 0 || cost <= 0) {
            // 没有成本记录，当作单纯减持
            shares -= qty;
            if (shares < 0) shares = 0;
          } else {
            const avg = cost / shares;
            shares -= qty;
            if (shares < 0) shares = 0;
            cost -= qty * avg;
            if (cost < 0) cost = 0;
          }
        }
      }

      if (shares <= 0 || !currentPrice) {
        return {
          shares: 0,
          cost: 0,
          costBasis: null,
          marketValue: 0,
          unrealizedPL: 0,
          unrealizedPLPct: null,
        };
      }

      const marketValue = shares * currentPrice;
      const unrealizedPL = marketValue - cost;
      const unrealizedPLPct = cost > 0 ? (unrealizedPL / cost) * 100 : null;

      return {
        shares,
        cost,
        costBasis: cost / shares,
        marketValue,
        unrealizedPL,
        unrealizedPLPct,
      };
    }

    // ------------------------
    // 读取 data.json + 行情
    // ------------------------
    async function loadDataAndQuotes() {
      // 1) 加载 data.json
      const res = await fetch("data.json?ts=" + Date.now());
      rawPositions = await res.json();

      // 2) 准备请求行情
      const symbolsYahoo = rawPositions.map(yahooSymbol).join(",");
      const quoteRes = await fetch(YAHOO_ENDPOINT + encodeURIComponent(symbolsYahoo));
      const quoteJson = await quoteRes.json();
      const results = quoteJson.quoteResponse?.result || [];

      const quoteMap = {};
      for (const q of results) {
        quoteMap[q.symbol] = q;
      }

      const now = new Date();
      document.getElementById("last-update").textContent =
        "最后更新：" +
        now.toLocaleString("zh-CN", { hour12: false });

      // 3) 合并数据
      positions = rawPositions.map((p) => {
        const ySym = yahooSymbol(p);
        const q = quoteMap[ySym] || {};
        const price = q.regularMarketPrice || null;
        const prevClose = q.regularMarketPreviousClose || null;
        const changeToday = q.regularMarketChange || null;
        const changeTodayPct = q.regularMarketChangePercent || null;

        return {
          ...p,
          yahooSymbol: ySym,
          price,
          prevClose,
          changeToday,
          changeTodayPct,
        };
      });

      // 4) 结合交易记录计算成本 & 盈亏
      enrichPositionsWithTrades();
      updateSummaryAndCharts();
      renderPositions();
      renderTradesList();
    }

    function enrichPositionsWithTrades() {
      positions = positions.map((p) => {
        const tradeResult = computePositionFromTrades(p.symbol, p.price);
        let marketValue = tradeResult.marketValue;
        let cost = tradeResult.cost;
        let shares = tradeResult.shares;
        let unrealizedPL = tradeResult.unrealizedPL;
        let unrealizedPLPct = tradeResult.unrealizedPLPct;

        // 如果没有交易记录，用 data.json 的 value 作为市值参考
        if (!shares && !marketValue && p.value) {
          marketValue = p.value;
          if (p.price) {
            shares = p.value / p.price;
          }
        }

        return {
          ...p,
          shares,
          cost,
          costBasis: tradeResult.costBasis,
          marketValue,
          unrealizedPL,
          unrealizedPLPct,
        };
      });
    }

    // ------------------------
    // 汇总 & 图表
    // ------------------------
    function updateSummaryAndCharts() {
      let totalValue = 0;
      let totalUnrealized = 0;
      let totalCost = 0;
      let totalTodayPL = 0;
      let totalPrevValue = 0;

      positions.forEach((p) => {
        const mv = p.marketValue || 0;
        totalValue += mv;

        if (p.cost && p.costBasis && p.unrealizedPL !== undefined) {
          totalUnrealized += p.unrealizedPL;
          totalCost += p.cost;
        }

        if (p.changeToday !== null && p.changeToday !== undefined && p.shares) {
          totalTodayPL += p.changeToday * p.shares;
          const prevPrice = p.prevClose || (p.price - p.changeToday);
          const prevVal = prevPrice * p.shares;
          totalPrevValue += prevVal;
        }
      });

      // 顶部数字
      document.getElementById("stat-total-value").textContent =
        formatNumber(totalValue, 2);

      const unrealRate =
        totalCost > 0 ? (totalUnrealized / totalCost) * 100 : null;

      const unrealEl = document.getElementById("stat-unrealized-pl");
      unrealEl.textContent = formatNumber(totalUnrealized, 2);

      const unrealPill = document.getElementById("stat-unrealized-rate-pill");
      unrealPill.textContent = unrealRate !== null ? formatPercent(unrealRate) : "--";
      unrealPill.className =
        "pill " +
        (unrealRate === null
          ? ""
          : unrealRate >= 0
          ? "pill-green"
          : "pill-red");

      // 今日盈亏
      document.getElementById("stat-today-pl").textContent =
        formatNumber(totalTodayPL, 2);
      const todayRate =
        totalPrevValue > 0 ? (totalTodayPL / totalPrevValue) * 100 : null;
      const todayPill = document.getElementById("stat-today-rate-pill");
      todayPill.textContent = todayRate !== null ? formatPercent(todayRate) : "--";
      todayPill.className =
        "pill " +
        (todayRate === null
          ? ""
          : todayRate >= 0
          ? "pill-green"
          : "pill-red");

      // 图表数据
      renderPieChart();
      renderBarChart();
    }

    function renderPieChart() {
      const dom = document.getElementById("pie-chart");
      if (!pieChart) {
        pieChart = echarts.init(dom, null, { renderer: "canvas" });
      }

      const total = positions.reduce(
        (acc, p) => acc + (p.marketValue || 0),
        0
      );
      const data = positions
        .filter((p) => p.marketValue)
        .map((p) => ({
          name: p.symbol + " · " + p.name,
          value: p.marketValue,
          percent: total ? (p.marketValue / total) * 100 : 0,
        }))
        .sort((a, b) => b.value - a.value);

      const option = {
        backgroundColor: "transparent",
        tooltip: {
          trigger: "item",
          formatter: (params) => {
            const d = params.data;
            return `
              <div style="font-size:12px;">
                <div>${d.name}</div>
                <div>市值：${formatNumber(d.value, 2)}</div>
                <div>占比：${formatPercent(d.percent, 2)}</div>
              </div>
            `;
          },
        },
        series: [
          {
            type: "pie",
            radius: ["42%", "72%"],
            center: ["50%", "50%"],
            avoidLabelOverlap: true,
            itemStyle: {
              borderRadius: 6,
              borderColor: "#020617",
              borderWidth: 1,
            },
            label: {
              show: true,
              formatter: (p) => `${p.name.split(" · ")[0]}\n${p.percent.toFixed(1)}%`,
              color: "#e5e7eb",
              fontSize: 11,
            },
            labelLine: {
              smooth: true,
              length: 10,
              length2: 8,
            },
            data,
          },
        ],
        color: [
          "#22c55e",
          "#38bdf8",
          "#a855f7",
          "#eab308",
          "#f97316",
          "#f97373",
          "#0ea5e9",
          "#22d3ee",
          "#4ade80",
        ],
      };

      pieChart.setOption(option);
    }

    function renderBarChart() {
      const dom = document.getElementById("bar-chart");
      if (!barChart) {
        barChart = echarts.init(dom, null, { renderer: "canvas" });
      }

      const names = [];
      const costData = [];
      const valueData = [];

      positions.forEach((p) => {
        if (!p.marketValue) return;

        names.push(p.symbol);
        valueData.push(p.marketValue);

        if (p.cost && p.costBasis) {
          costData.push(p.cost);
        } else {
          costData.push(null);
        }
      });

      const option = {
        backgroundColor: "transparent",
        tooltip: {
          trigger: "axis",
          axisPointer: { type: "shadow" },
          formatter: (params) => {
            let html = `<div style="font-size:12px;">标的：${params[0].axisValue}</div>`;
            params.forEach((p) => {
              html += `<div>${p.marker}${p.seriesName}：${formatNumber(
                p.data || 0,
                2
              )}</div>`;
            });
            return html;
          },
        },
        grid: {
          left: 40,
          right: 12,
          top: 20,
          bottom: 30,
        },
        xAxis: {
          type: "category",
          data: names,
          axisLabel: { color: "#9ca3af", fontSize: 11 },
          axisLine: { lineStyle: { color: "#374151" } },
        },
        yAxis: {
          type: "value",
          axisLabel: {
            color: "#9ca3af",
            fontSize: 11,
            formatter: (v) => v >= 10000 ? (v / 10000).toFixed(1) + "万" : v,
          },
          splitLine: {
            lineStyle: { color: "rgba(55,65,81,0.7)", type: "dashed" },
          },
        },
        legend: {
          top: 0,
          right: 8,
          textStyle: { color: "#9ca3af", fontSize: 11 },
        },
        series: [
          {
            name: "成本",
            type: "bar",
            data: costData,
            itemStyle: {
              color: "rgba(148,163,184,0.7)",
            },
            barWidth: 10,
          },
          {
            name: "当前市值",
            type: "bar",
            data: valueData,
            itemStyle: {
              color: "#22c55e",
            },
            barWidth: 10,
          },
        ],
      };

      barChart.setOption(option);
    }

    // ------------------------
    // 渲染持仓列表
    // ------------------------
    function renderPositions() {
      const container = document.getElementById("positions-list");
      container.innerHTML = "";

      positions.forEach((p) => {
        const row = document.createElement("div");
        row.className = "position-card";

        const catClass =
          p.category === "core"
            ? "tag tag-core"
            : p.category === "satellite"
            ? "tag tag-sat"
            : "tag tag-tech";

        const plClass =
          p.unrealizedPL !== null && p.unrealizedPL !== undefined
            ? p.unrealizedPL >= 0
              ? "pos-pl-pos"
              : "pos-pl-neg"
            : "";

        const plPctText =
          p.unrealizedPLPct !== null && p.unrealizedPLPct !== undefined
            ? formatPercent(p.unrealizedPLPct)
            : "--";

        const todayClass =
          p.changeToday !== null && p.changeToday !== undefined
            ? p.changeToday >= 0
              ? "pos-pl-pos"
              : "pos-pl-neg"
            : "";

        const todayPctText =
          p.changeTodayPct !== null && p.changeTodayPct !== undefined
            ? formatPercent(p.changeTodayPct)
            : "--";

        row.innerHTML = `
          <div class="pos-main">
            <div class="pos-name-line">
              <span class="pos-symbol">${p.symbol}</span>
              <span class="pos-name">${p.name}</span>
            </div>
            <div style="display:flex;align-items:center;gap:6px;">
              <span class="${catClass}">
                ${
                  p.category === "core"
                    ? "Core Index"
                    : p.category === "satellite"
                    ? "High Vol"
                    : "Tech Giants"
                }
              </span>
              <span class="tag">${p.market}</span>
            </div>
          </div>

          <div>
            <div class="pos-label">市值</div>
            <div class="pos-value-main">${formatNumber(p.marketValue, 2)}</div>
            <div class="pos-value-sub">价格：${formatNumber(
              p.price,
              2
            )}</div>
          </div>

          <div class="pos-hide-mobile">
            <div class="pos-label">持仓</div>
            <div class="pos-value-main">${p.shares
              ? formatNumber(p.shares, 4)
              : "--"}</div>
            <div class="pos-value-sub">成本价：${
              p.costBasis ? formatNumber(p.costBasis, 2) : "--"
            }</div>
          </div>

          <div class="pos-hide-tablet">
            <div class="pos-label">浮动盈亏</div>
            <div class="pos-value-main ${plClass}">
              ${formatNumber(p.unrealizedPL, 2)}
            </div>
            <div class="pos-value-sub ${plClass}">
              ${plPctText}
            </div>
          </div>

          <div class="pos-hide-tablet">
            <div class="pos-label">今日</div>
            <div class="pos-value-main ${todayClass}">
              ${p.changeToday !== null && p.shares
                ? formatNumber(p.changeToday * p.shares, 2)
                : "--"}
            </div>
            <div class="pos-value-sub ${todayClass}">
              ${todayPctText}
            </div>
          </div>

          <div style="text-align:right;">
            <button class="small-btn" data-symbol="${p.symbol}">
              ✚ 记录交易
            </button>
          </div>
        `;

        container.appendChild(row);
      });

      // 为每个「记录交易」按钮绑定事件
      Array.from(document.querySelectorAll(".small-btn")).forEach((btn) => {
        btn.addEventListener("click", () => {
          const sym = btn.getAttribute("data-symbol");
          document.getElementById("trade-symbol").value = sym;
          document.getElementById("trade-price").focus();
        });
      });
    }

    // ------------------------
    // 渲染交易列表（最近）
    // ------------------------
    function renderTradesList() {
      const container = document.getElementById("trades-list");
      container.innerHTML = "";

      const rows = [];
      for (const [symbol, list] of Object.entries(tradesBySymbol)) {
        list.forEach((t) => {
          rows.push({ symbol, ...t });
        });
      }

      if (!rows.length) {
        container.innerHTML =
          '<div style="color: var(--text-muted);">暂无交易记录。保存交易后将在此展示最近记录。</div>';
        return;
      }

      rows.sort((a, b) => (b.date || "").localeCompare(a.date || ""));

      rows.slice(0, 30).forEach((t) => {
        const row = document.createElement("div");
        row.className = "trades-list-row";
        row.innerHTML = `
          <div>
            <span class="chip ${
              t.type === "buy" ? "chip-buy" : "chip-sell"
            }">${t.type === "buy" ? "买入" : "卖出"}</span>
            <span style="margin-left:6px;">${t.symbol}</span>
            <span style="margin-left:6px;color:var(--text-main);">${formatNumber(
              t.price,
              3
            )}</span>
            <span style="margin-left:6px;">× ${formatNumber(t.qty, 4)}</span>
          </div>
          <div>${t.date || ""}</div>
        `;
        container.appendChild(row);
      });
    }

    // ------------------------
    // 初始化表单 & 事件
    // ------------------------
    function initTradeSymbolOptions() {
      const sel = document.getElementById("trade-symbol");
      sel.innerHTML = "";
      positions.forEach((p) => {
        const opt = document.createElement("option");
        opt.value = p.symbol;
        opt.textContent = `${p.symbol} · ${p.name}`;
        sel.appendChild(opt);
      });
    }

    function initEvents() {
      document
        .getElementById("trade-form")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          const symbol = document.getElementById("trade-symbol").value;
          const type = document.getElementById("trade-type").value;
          const price = parseFloat(
            document.getElementById("trade-price").value
          );
          const qty = parseFloat(document.getElementById("trade-qty").value);
          const date =
            document.getElementById("trade-date").value ||
            new Date().toISOString().slice(0, 10);

          if (!symbol || !price || !qty) {
            alert("请完整填写交易信息");
            return;
          }

          if (!tradesBySymbol[symbol]) tradesBySymbol[symbol] = [];
          tradesBySymbol[symbol].push({ type, price, qty, date });
          saveTradesToStorage();
          enrichPositionsWithTrades();
          updateSummaryAndCharts();
          renderPositions();
          renderTradesList();
          showToast("交易已保存：" + symbol);

          // 清理输入数量和价格
          document.getElementById("trade-price").value = "";
          document.getElementById("trade-qty").value = "";
        });

      document
        .getElementById("plan-notes")
        .addEventListener("change", savePlanToStorage);
      document
        .getElementById("plan-notes")
        .addEventListener("blur", savePlanToStorage);

      document
        .getElementById("refresh-quotes")
        .addEventListener("click", async () => {
          try {
            await loadDataAndQuotes();
            initTradeSymbolOptions();
            showToast("行情已刷新");
          } catch (e) {
            console.error(e);
            alert("刷新行情失败，请稍后重试");
          }
        });

      document.getElementById("reset-data").addEventListener("click", () => {
        if (
          confirm(
            "确认要重置本地数据吗？这将清空所有已保存的交易记录和计划，但不会影响仓位本身。"
          )
        ) {
          localStorage.removeItem(TRADES_KEY);
          localStorage.removeItem(PLAN_KEY);
          tradesBySymbol = {};
          loadPlanFromStorage();
          enrichPositionsWithTrades();
          updateSummaryAndCharts();
          renderPositions();
          renderTradesList();
          showToast("本地数据已重置");
        }
      });
    }

    // ------------------------
    // 页面入口
    // ------------------------
    window.addEventListener("DOMContentLoaded", async () => {
      loadTradesFromStorage();
      loadPlanFromStorage();
      initEvents();

      try {
        await loadDataAndQuotes();
        initTradeSymbolOptions();
      } catch (e) {
        console.error(e);
        alert(
          "加载数据或行情失败。请检查网络，或稍后刷新页面重试。\n（如果是行情接口跨域问题，可以尝试切换网络/浏览器）"
        );
      }

      // 自适应图表大小
      window.addEventListener("resize", () => {
        pieChart && pieChart.resize();
        barChart && barChart.resize();
      });
    });
  </script>
</body>
</html>
