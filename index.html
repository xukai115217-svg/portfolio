
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æˆ‘çš„æŒä»“é¢æ¿ v2.0</title>

<!-- TradingView æ·±è‰²é£æ ¼ -->
<style>
    body {
        background: #0d1117;
        color: #e6edf3;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        margin: 0;
        padding: 0;
    }

    h1 {
        padding: 20px;
        margin: 0;
        font-size: 28px;
        font-weight: 600;
    }

    .card {
        background: #161b22;
        padding: 20px;
        border-radius: 14px;
        margin: 16px;
        box-shadow: 0 0 20px rgba(0,0,0,0.25);
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
        gap: 16px;
        padding: 16px;
    }

    .position-table {
        width: 100%;
        border-collapse: collapse;
        color: #e6edf3;
        font-size: 15px;
    }

    .position-table th {
        text-align: left;
        padding: 8px;
        background: #1f242d;
    }

    .position-table td {
        padding: 8px;
        border-top: 1px solid #30363d;
    }

    .green { color: #3fb950; }
    .red { color: #f85149; }

    .chart-container {
        width: 100%;
        height: 360px;
    }

    .input-box {
        background: #161b22;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 12px;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>ğŸ“ˆ æˆ‘çš„æŠ•èµ„é¢æ¿ v2.0</h1>

<div class="grid">

    <!-- æŒä»“åˆ†å¸ƒå›¾ -->
    <div class="card">
        <h2>æŒä»“åˆ†å¸ƒ</h2>
        <canvas id="pieChart"></canvas>
    </div>

    <!-- æµ®åŠ¨ç›ˆäº -->
    <div class="card">
        <h2>æ€»ç›ˆäº</h2>
        <div id="totalPnL" style="font-size:32px;font-weight:600;">--</div>
        <div id="totalPnLPercent" style="font-size:20px;margin-top:8px;">--</div>
    </div>

</div>

<!-- æŒä»“æ˜ç»†å¡ç‰‡ -->
<div class="card">
    <h2>æŒä»“æ˜ç»†ï¼ˆå®æ—¶åˆ·æ–°ï¼‰</h2>

    <table class="position-table" id="positionTable">
        <thead>
            <tr>
                <th>è‚¡ç¥¨</th>
                <th>æ•°é‡</th>
                <th>æˆæœ¬ä»·</th>
                <th>ç°ä»·</th>
                <th>å¸‚å€¼</th>
                <th>ç›ˆäºé‡‘é¢</th>
                <th>ç›ˆäº%</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- è¾“å…¥äº¤æ˜“ -->
<div class="card">
    <h2>âœ æ·»åŠ ä¹°å–è®°å½•ï¼ˆè‡ªåŠ¨æ›´æ–°æˆæœ¬ï¼‰</h2>

    <div class="input-box">
        è‚¡ç¥¨ä»£ç ï¼š<input id="tradeSymbol" placeholder="å¦‚ AAPL" />
    </div>
    <div class="input-box">
        ä¹°å…¥/å–å‡ºä»·æ ¼ï¼š<input id="tradePrice" type="number" step="0.01" />
    </div>
    <div class="input-box">
        æ•°é‡ï¼ˆä¹°å…¥æ­£æ•°ï¼Œå–å‡ºè´Ÿæ•°ï¼‰ï¼š<input id="tradeQty" type="number" />
    </div>

    <button onclick="applyTrade()" style="padding:10px 18px;border-radius:12px;border:none;background:#238636;color:white;font-size:16px;">
        æäº¤äº¤æ˜“
    </button>
</div>

<script>
/* -------------------------
   åŠ è½½ data.json
------------------------- */
let holdings = {};

async function loadHoldings() {
    const res = await fetch("data.json");
    holdings = await res.json();
    refreshData();
}

/* -------------------------
   Fetch å®æ—¶ä»·æ ¼ï¼ˆTwelveDataï¼‰
------------------------- */
const API_KEY = "eac5e5832df94c789a5adadb864956e9";

async function getPrice(symbol) {
    try {
        const url = `https://api.twelvedata.com/price?symbol=${symbol}&apikey=${API_KEY}`;
        const res = await fetch(url);
        const data = await res.json();
        return parseFloat(data.price);
    } catch (e) {
        return null;
    }
}

/* -------------------------
   ä¸»åˆ·æ–°é€»è¾‘
------------------------- */
async function refreshData() {
    let labels = [];
    let values = [];
    let tbody = "";
    let totalValue = 0;
    let totalCost = 0;

    for (const sym in holdings) {
        const h = holdings[sym];
        const qty = h.qty;
        const cost = h.cost;

        const price = await getPrice(sym);
        const value = price * qty;
        const pnl = value - cost * qty;
        const pnlPct = pnl / (cost * qty) * 100;

        labels.push(sym);
        values.push(value);

        totalValue += value;
        totalCost += cost * qty;

        tbody += `
            <tr>
                <td>${sym}</td>
                <td>${qty}</td>
                <td>${cost.toFixed(2)}</td>
                <td>${price.toFixed(2)}</td>
                <td>${value.toFixed(2)}</td>
                <td class="${pnl >= 0 ? "green" : "red"}">${pnl.toFixed(2)}</td>
                <td class="${pnl >= 0 ? "green" : "red"}">${pnlPct.toFixed(2)}%</td>
            </tr>
        `;
    }

    document.querySelector("#positionTable tbody").innerHTML = tbody;

    const totalPnL = totalValue - totalCost;
    document.getElementById("totalPnL").textContent = totalPnL.toFixed(2);
    document.getElementById("totalPnLPercent").textContent =
        (totalPnL / totalCost * 100).toFixed(2) + "%";

    updatePie(labels, values);
}

/* -------------------------
   é¥¼å›¾
------------------------- */
let pieChart;

function updatePie(labels, values) {
    if (pieChart) pieChart.destroy();

    pieChart = new Chart(document.getElementById("pieChart"), {
        type: "pie",
        data: {
            labels,
            datasets: [{
                data: values,
                backgroundColor: [
                    "#4e79a7","#59a14f","#9c755f","#f28e2b","#edc948",
                    "#bab0ab","#e15759","#76b7b2","#ff9da7"
                ]
            }]
        }
    });
}

/* -------------------------
   æ·»åŠ äº¤æ˜“è®°å½•ï¼ˆè‡ªåŠ¨ç®—æˆæœ¬ï¼‰
------------------------- */
function applyTrade() {
    const sym = document.getElementById("tradeSymbol").value.toUpperCase();
    const price = parseFloat(document.getElementById("tradePrice").value);
    const qty = parseFloat(document.getElementById("tradeQty").value);

    if (!holdings[sym]) holdings[sym] = { qty: 0, cost: price };

    const h = holdings[sym];

    const newQty = h.qty + qty;
    if (newQty <= 0) {
        h.qty = 0;
        return;
    }

    h.cost = (h.cost * h.qty + price * qty) / newQty;
    h.qty = newQty;

    localStorage.setItem("holdings", JSON.stringify(holdings));
    refreshData();
}

window.onload = loadHoldings;
</script>

</body>
</html>
