
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æˆ‘çš„æŒä»“é¢æ¿ v2.0</title>

  <!-- TradingView æ·±è‰²é£æ ¼ -->
  <style>
    :root {
      --bg: #0d1117;
      --card: #161b22;
      --card-soft: #1b222c;
      --border: #30363d;
      --text: #e6edf3;
      --muted: #8b949e;
      --up: #3fb950;
      --down: #f85149;
      --primary: #238636;
    }

    * { box-sizing: border-box; }

    body {
      background: radial-gradient(circle at top left, #161b22 0, #02040a 45%, #000 100%);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      min-height: 100vh;
    }

    header {
      padding: 20px 24px 12px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
    }

    header small {
      color: var(--muted);
      font-size: 13px;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(35,134,54,0.15);
      color: var(--up);
      font-size: 12px;
      border: 1px solid rgba(63,185,80,0.4);
    }

    .grid-main {
      display: grid;
      grid-template-columns: 2.1fr 1.3fr;
      gap: 16px;
      padding: 0 16px 16px;
    }

    @media (max-width: 960px){
      .grid-main { grid-template-columns: 1fr; }
    }

    .card {
      background: rgba(22,27,34,0.96);
      border-radius: 18px;
      border: 1px solid rgba(240,246,252,0.04);
      box-shadow: 0 18px 45px rgba(0,0,0,0.65);
      padding: 18px 20px;
      backdrop-filter: blur(16px);
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 17px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card h2 span.badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .kpi-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .kpi {
      flex: 1;
      min-width: 140px;
      padding: 12px 14px;
      border-radius: 14px;
      background: radial-gradient(circle at top left,#202938 0,#141822 55%,#0f131c 100%);
      border: 1px solid rgba(240,246,252,0.03);
    }

    .kpi-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .kpi-value {
      font-size: 22px;
      font-weight: 600;
    }

    .kpi-sub {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .flex {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .flex-1 { flex: 1; min-width: 260px; }

    .table-wrap {
      max-height: 520px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
      margin-top: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      padding: 8px 10px;
      text-align: right;
      white-space: nowrap;
    }

    th:first-child, td:first-child { text-align: left; }

    thead {
      position: sticky;
      top: 0;
      background: #111620;
      z-index: 1;
    }

    tbody tr:nth-child(2n) {
      background: rgba(15,19,28,0.8);
    }

    tbody tr:hover {
      background: rgba(40,52,70,0.9);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(33,38,45,0.9);
      border: 1px solid rgba(57,63,75,0.9);
      font-size: 11px;
      color: var(--muted);
    }

    .chip {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(240,246,252,0.06);
      color: var(--muted);
      margin-left: 6px;
    }

    .up { color: var(--up); }
    .down { color: var(--down); }

    .chart-box {
      height: 260px;
      margin-top: 4px;
    }

    .inputs-row {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(130px,1fr));
      gap: 10px;
      margin: 8px 0 12px;
    }

    .input-group {
      background: var(--card-soft);
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .input-group label {
      font-size: 11px;
      color: var(--muted);
      display: block;
      margin-bottom: 4px;
    }

    .input-group input {
      width: 100%;
      border: none;
      outline: none;
      background: transparent;
      color: var(--text);
      font-size: 13px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 13px;
      cursor: pointer;
      background: linear-gradient(135deg,#26a641,#2ea043);
      color: #fff;
      font-weight: 500;
      box-shadow: 0 8px 18px rgba(46,160,67,0.45);
    }

    .btn.secondary {
      background: transparent;
      border: 1px solid var(--border);
      box-shadow: none;
      color: var(--muted);
      margin-left: 8px;
    }

    .status {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header>
  <div>
    <h1>ğŸ“Š æˆ‘çš„æŒä»“é¢æ¿ v2.0</h1>
    <small>å®æ—¶ä»·æ ¼æ¥è‡ª TwelveData Â· é¦–æ¬¡åŠ è½½ä¼šç”¨ <code>value Ã· å®æ—¶ä»·æ ¼</code> ä¼°ç®—æ•°é‡ & æˆæœ¬</small>
  </div>
  <div>
    <span class="pill">æ ¸å¿ƒ 35% Â· ç§‘æŠ€ 55% Â· å«æ˜Ÿ 10%</span>
  </div>
</header>

<div class="grid-main">
  <!-- å·¦ï¼šæ€»è§ˆ + æ˜ç»† -->
  <section class="card">
    <h2>
      æŒä»“æ€»è§ˆ
      <span class="badge" id="updateTime">åˆå§‹åŒ–ä¸­...</span>
    </h2>

    <div class="kpi-row">
      <div class="kpi">
        <div class="kpi-label">æ€»å¸‚å€¼</div>
        <div class="kpi-value" id="kpiTotalValue">--</div>
        <div class="kpi-sub">æŒ‰æœ€æ–°è¡Œæƒ…ä¼°ç®—</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">æ€»ç›ˆäº</div>
        <div class="kpi-value" id="kpiTotalPnL">--</div>
        <div class="kpi-sub" id="kpiTotalPnLPercent">--</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">ä»“ä½æ•°é‡ï¼ˆä¼°ç®—ï¼‰</div>
        <div class="kpi-value" id="kpiTotalQty">--</div>
        <div class="kpi-sub">ä»…ç»Ÿè®¡å·²æˆåŠŸè·å–ä»·æ ¼çš„æ ‡çš„</div>
      </div>
    </div>

    <div class="table-wrap">
      <table id="positionTable">
        <thead>
          <tr>
            <th>æ ‡çš„</th>
            <th>æ•°é‡</th>
            <th>æˆæœ¬ä»·</th>
            <th>ç°ä»·</th>
            <th>å¸‚å€¼</th>
            <th>ç›ˆäº</th>
            <th>ç›ˆäº%</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="status" id="statusText">æ­£åœ¨ä» data.json åˆå§‹åŒ–æŒä»“...</div>
  </section>

  <!-- å³ï¼šå›¾è¡¨ + äº¤æ˜“è¾“å…¥ -->
  <section class="card">
    <h2>
      ä»“ä½åˆ†å¸ƒ & äº¤æ˜“
      <span class="badge">æ·±è‰² Â· TradingView é£æ ¼</span>
    </h2>

    <div class="chart-box">
      <canvas id="pieChart"></canvas>
    </div>

    <hr style="border:none;border-top:1px solid var(--border);margin:14px 0;" />

    <div class="inputs-row">
      <div class="input-group">
        <label>è‚¡ç¥¨ä»£ç ï¼ˆsymbolï¼‰</label>
        <input id="tradeSymbol" placeholder="å¦‚ NVDA / QQQ / 0700" />
      </div>
      <div class="input-group">
        <label>ä»·æ ¼ï¼ˆä¹°å…¥/å–å‡ºï¼‰</label>
        <input id="tradePrice" type="number" step="0.01" placeholder="USD æˆ– HKD" />
      </div>
      <div class="input-group">
        <label>æ•°é‡ï¼ˆä¹°å…¥æ­£æ•° Â· å–å‡ºè´Ÿæ•°ï¼‰</label>
        <input id="tradeQty" type="number" step="0.01" />
      </div>
    </div>
    <button class="btn" onclick="applyTrade()">æäº¤äº¤æ˜“</button>
    <button class="btn secondary" onclick="resetHoldings()">é‡ç½®ä¸º data.json ä¼°ç®—</button>

    <div class="status" id="tradeStatus"></div>
  </section>
</div>

<script>
  const API_KEY = "eac5e5832df94c789a5adadb864956e9";
  const QTY_DECIMALS = 2;

  let rawPositions = [];         // æ¥è‡ª data.json çš„åŸå§‹æ•°æ®ï¼ˆå« valueï¼‰
  let holdings = {};             // {symbol: {qty, cost}}
  let lastPrices = {};           // {symbol: price}
  let pieChart = null;

  // ---------------- å·¥å…·å‡½æ•° ----------------

  const fmtMoney = (v) =>
    isFinite(v) ? v.toLocaleString("en-US", {minimumFractionDigits:2,maximumFractionDigits:2}) : "--";

  const fmtQty = (v) =>
    isFinite(v) ? v.toFixed(QTY_DECIMALS) : "--";

  function setStatus(msg) {
    document.getElementById("statusText").textContent = msg;
  }

  // TwelveData US tickerï¼šç›´æ¥ symbol
  function buildUsTicker(symbol) {
    return symbol;
  }

  // TwelveData HK tickerï¼šè‡ªåŠ¨å°è¯•å¤šç§æ ¼å¼ï¼ˆA2ï¼‰
  function buildHkTickerCandidates(symbol) {
    // symbol å¯èƒ½æ˜¯ "0700"ã€"3690" ç­‰
    const s = symbol.replace(/^0+/, ""); // å»æ‰å‰å¯¼ 0ï¼Œä¾‹å¦‚ 0700 -> 700
    return [
      `${symbol}.HK`,
      `${s}.HK`,
      `${symbol}.XHKG`,
      `${s}.XHKG`,
      symbol,
      s
    ];
  }

  async function fetchPriceWithCandidates(candidates) {
    for (const t of candidates) {
      try {
        const url = `https://api.twelvedata.com/price?symbol=${encodeURIComponent(t)}&apikey=${API_KEY}`;
        const res = await fetch(url);
        const data = await res.json();
        if (data && data.price && !isNaN(parseFloat(data.price))) {
          return parseFloat(data.price);
        }
      } catch(e) {
        // å¿½ç•¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª
      }
    }
    return null;
  }

  async function getPrice(symbol, market) {
    if (lastPrices[symbol]) return lastPrices[symbol];

    let price = null;
    if (market === "US") {
      const ticker = buildUsTicker(symbol);
      price = await fetchPriceWithCandidates([ticker]);
    } else if (market === "HK") {
      const cands = buildHkTickerCandidates(symbol);
      price = await fetchPriceWithCandidates(cands);
    } else {
      // å…¶ä»–å¸‚åœºæš‚ä¸å¤„ç†
      price = null;
    }

    if (price !== null) lastPrices[symbol] = price;
    return price;
  }

  // ---------------- åˆå§‹åŒ–æŒä»“ ----------------

  async function initFromDataJson() {
    setStatus("æ­£åœ¨ä» data.json è¯»å–ä»“ä½...");
    const res = await fetch("data.json");
    rawPositions = await res.json();   // æ•°ç»„: {symbol,name,market,category,value}
    // å°è¯•ä» localStorage æ¢å¤çœŸå®æŒä»“
    const saved = localStorage.getItem("holdings_v2");
    if (saved) {
      holdings = JSON.parse(saved);
      setStatus("å·²ä»æœ¬åœ°ä¿å­˜çš„æŒä»“æ¢å¤ã€‚æ­£åœ¨åˆ·æ–°æœ€æ–°ä»·æ ¼...");
    } else {
      setStatus("æœªå‘ç°æœ¬åœ°æŒä»“è®°å½•ï¼Œæ­£åœ¨ç”¨ value Ã· å®æ—¶ä»·æ ¼ ä¼°ç®—åˆå§‹æ•°é‡å’Œæˆæœ¬...");
      holdings = {};
      for (const p of rawPositions) {
        if (!p.symbol || !p.value) continue;
        const sym = p.symbol.toUpperCase();
        const price = await getPrice(sym, p.market);
        if (!price) continue;
        const qty = +(p.value / price).toFixed(QTY_DECIMALS);
        holdings[sym] = { qty, cost: price };  // å‡è®¾åˆå§‹æ— æµ®ç›ˆäº
      }
      localStorage.setItem("holdings_v2", JSON.stringify(holdings));
      setStatus("åˆå§‹ä¼°ç®—å®Œæˆã€‚ä¹‹åä½ çš„ä¹°å–è®°å½•éƒ½ä¼šä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ã€‚");
    }

    await refreshAll();
  }

  async function refreshAll() {
    if (!rawPositions.length) return;

    // ä¸ºæ‰€æœ‰ symbol æ›´æ–°ä¸€æ¬¡æœ€æ–°ä»·æ ¼
    const syms = Object.keys(holdings);
    for (const s of syms) {
      const meta = rawPositions.find(p => p.symbol.toUpperCase() === s);
      if (!meta) continue;
      await getPrice(s, meta.market);
    }

    renderPositions();
    renderPie();
    updateKpis();
    document.getElementById("updateTime").textContent =
      "æ›´æ–°äº " + new Date().toLocaleTimeString("zh-CN", {hour12:false});
  }

  // ---------------- æ¸²æŸ“è¡¨æ ¼ ----------------

  function renderPositions() {
    const tbody = document.querySelector("#positionTable tbody");
    tbody.innerHTML = "";

    for (const p of rawPositions) {
      const sym = p.symbol.toUpperCase();
      const h = holdings[sym];
      if (!h) continue;
      const price = lastPrices[sym];
      if (!price) continue;

      const qty = h.qty;
      const cost = h.cost;
      const value = qty * price;
      const costValue = qty * cost;
      const pnl = value - costValue;
      const pnlPct = costValue ? pnl / costValue * 100 : 0;

      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      tdName.innerHTML = `
        <div>${p.name || sym}</div>
        <div class="tag">${sym}<span class="chip">${p.market || ""} Â· ${p.category || ""}</span></div>
      `;

      const tdQty = document.createElement("td");
      tdQty.textContent = fmtQty(qty);

      const tdCost = document.createElement("td");
      tdCost.textContent = fmtMoney(cost);

      const tdPrice = document.createElement("td");
      tdPrice.textContent = price ? fmtMoney(price) : "--";

      const tdVal = document.createElement("td");
      tdVal.textContent = fmtMoney(value);

      const tdPnL = document.createElement("td");
      tdPnL.textContent = fmtMoney(pnl);
      tdPnL.className = pnl >= 0 ? "up" : "down";

      const tdPct = document.createElement("td");
      tdPct.textContent = isFinite(pnlPct) ? pnlPct.toFixed(2) + "%" : "--";
      tdPct.className = pnl >= 0 ? "up" : "down";

      tr.append(tdName, tdQty, tdCost, tdPrice, tdVal, tdPnL, tdPct);
      tbody.appendChild(tr);
    }
  }

  // ---------------- KPI & é¥¼å›¾ ----------------

  function updateKpis() {
    let totalValue = 0;
    let totalCost = 0;
    let totalQty = 0;

    for (const p of rawPositions) {
      const sym = p.symbol.toUpperCase();
      const h = holdings[sym];
      const price = lastPrices[sym];
      if (!h || !price) continue;
      const qty = h.qty;
      const cost = h.cost;
      const value = qty * price;
      const costValue = qty * cost;
      totalValue += value;
      totalCost += costValue;
      totalQty += qty;
    }

    const pnl = totalValue - totalCost;
    const pnlPct = totalCost ? pnl / totalCost * 100 : 0;

    document.getElementById("kpiTotalValue").textContent = fmtMoney(totalValue);
    document.getElementById("kpiTotalPnL").textContent =
      (pnl >= 0 ? "+" : "") + fmtMoney(pnl);
    document.getElementById("kpiTotalPnL").className = pnl >= 0 ? "kpi-value up" : "kpi-value down";
    document.getElementById("kpiTotalPnLPercent").textContent =
      (pnlPct >= 0 ? "+" : "") + pnlPct.toFixed(2) + "%";
    document.getElementById("kpiTotalQty").textContent = fmtQty(totalQty);
  }

  function renderPie() {
    const labels = [];
    const values = [];

    for (const p of rawPositions) {
      const sym = p.symbol.toUpperCase();
      const h = holdings[sym];
      const price = lastPrices[sym];
      if (!h || !price) continue;
      const qty = h.qty;
      const value = qty * price;
      labels.push(p.name || sym);
      values.push(value);
    }

    const ctx = document.getElementById("pieChart").getContext("2d");
    if (pieChart) pieChart.destroy();

    pieChart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: [
            "#4e79a7","#59a14f","#9c755f","#f28e2b","#edc948",
            "#bab0ab","#e15759","#76b7b2","#ff9da7","#b07aa1"
          ],
          borderWidth: 0
        }]
      },
      options: {
        plugins: {
          legend: {
            position: "bottom",
            labels: { color: "#e6edf3", boxWidth: 12, font: {size: 11} }
          }
        },
        cutout: "60%"
      }
    });
  }

  // ---------------- äº¤æ˜“å½•å…¥ ----------------

  function applyTrade() {
    const symInput = document.getElementById("tradeSymbol").value.trim();
    const priceInput = parseFloat(document.getElementById("tradePrice").value);
    const qtyInput = parseFloat(document.getElementById("tradeQty").value);
    const tradeStatus = document.getElementById("tradeStatus");

    if (!symInput || !isFinite(priceInput) || !isFinite(qtyInput) || qtyInput === 0) {
      tradeStatus.textContent = "è¯·å¡«å†™å®Œæ•´ï¼šä»£ç  / ä»·æ ¼ / æ•°é‡ï¼ˆæ•°é‡ä¹°å…¥ä¸ºæ­£ Â· å–å‡ºä¸ºè´Ÿï¼‰ã€‚";
      return;
    }

    const sym = symInput.toUpperCase();
    if (!holdings[sym]) {
      holdings[sym] = { qty: 0, cost: priceInput };
    }

    const h = holdings[sym];
    const prevQty = h.qty;
    const newQty = prevQty + qtyInput;

    if (newQty <= 0) {
      // æ¸…ä»“
      h.qty = 0;
      h.cost = priceInput;
    } else {
      // åŠ æƒå¹³å‡æˆæœ¬
      const prevCost = h.cost;
      h.cost = (prevCost * prevQty + priceInput * qtyInput) / newQty;
      h.qty = newQty;
    }

    localStorage.setItem("holdings_v2", JSON.stringify(holdings));
    tradeStatus.textContent = "å·²è®°å½•äº¤æ˜“ï¼Œæ­£åœ¨åˆ·æ–°...";

    refreshAll();
  }

  function resetHoldings() {
    if (!confirm("ç¡®è®¤è¦ä¸¢å¼ƒæ‰€æœ‰æœ¬åœ°æŒä»“è®°å½•ï¼Œé‡æ–°ç”¨ data.json + å®æ—¶ä»·æ ¼ä¼°ç®—å—ï¼Ÿ")) return;
    localStorage.removeItem("holdings_v2");
    holdings = {};
    lastPrices = {};
    initFromDataJson();
    document.getElementById("tradeStatus").textContent = "å·²é‡ç½®ï¼Œæœ¬åœ°ä¿å­˜çš„ä¹°å–è®°å½•å·²æ¸…ç©ºã€‚";
  }

  // ---------------- å¯åŠ¨ ----------------
  window.addEventListener("load", initFromDataJson);
</script>
</body>
</html>
